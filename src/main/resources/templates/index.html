<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tienda - Index</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .table-container { margin: 20px 0; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        button { padding: 5px 10px; margin: 2px; cursor: pointer; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%;
            height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px; width: 400px;
        }
        .modal-content input, select { width: 100%; margin: 5px 0; padding: 8px; }
    </style>
</head>
<body>
<div class="container">
    <h1 th:text="${mensaje}">Bienvenido a la Tienda</h1>
    <hr/>

    <!-- ========== CLIENTES ========== -->
    <h2>Clientes</h2>
    <button onclick="abrirModal('cliente')">‚ûï Nuevo Cliente</button>
    <div class="table-container">
        <table>
            <tr>
                <th>ID</th><th>Nombre</th><th>Documento</th><th>Email</th><th>Tel√©fono</th><th>Acciones</th>
            </tr>
            <tr th:each="c : ${clientes}">
                <td th:text="${c.id}"></td>
                <td th:text="${c.nombre}"></td>
                <td th:text="${c.documento}"></td>
                <td th:text="${c.email}"></td>
                <td th:text="${c.telefono}"></td>
                <td>
                    <button onclick="editar('cliente', [[${c.id}]])">‚úèÔ∏è</button>
                    <button onclick="eliminar('cliente', [[${c.id}]])">üóëÔ∏è</button>
                </td>
            </tr>
        </table>
    </div>

    <!-- ========== PRODUCTOS ========== -->
    <h2>Productos</h2>
    <button onclick="abrirModal('producto')">‚ûï Nuevo Producto</button>
    <div class="table-container">
        <table>
            <tr>
                <th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>Activo</th><th>Acciones</th>
            </tr>
            <tr th:each="p : ${productos}">
                <td th:text="${p.id}"></td>
                <td th:text="${p.nombre}"></td>
                <td th:text="${p.precio}"></td>
                <td th:text="${p.stockMinimo}"></td>
                <td th:text="${p.activo}"></td>
                <td>
                    <button onclick="editar('producto', [[${p.id}]])">‚úèÔ∏è</button>
                    <button onclick="eliminar('producto', [[${p.id}]])">üóëÔ∏è</button>
                </td>
            </tr>
        </table>
    </div>

    <!-- ========== PROVEEDORES ========== -->
    <h2>Proveedores</h2>
    <button onclick="abrirModal('proveedor')">‚ûï Nuevo Proveedor</button>
    <div class="table-container">
        <table>
            <tr>
                <th>ID</th><th>Nombre</th><th>Tel√©fono</th><th>Producto</th><th>Acciones</th>
            </tr>
            <tr th:each="pr : ${proveedores}">
                <td th:text="${pr.id}"></td>
                <td th:text="${pr.Nombre}"></td>
                <td th:text="${pr.Telefono}"></td>
                <td th:text="${pr.producto.nombre}"></td>
                <td>
                    <button onclick="editar('proveedor', [[${pr.id}]])">‚úèÔ∏è</button>
                    <button onclick="eliminar('proveedor', [[${pr.id}]])">üóëÔ∏è</button>
                </td>
            </tr>
        </table>
    </div>

    <!-- ========== USUARIOS ========== -->
    <h2>Usuarios</h2>
    <button onclick="abrirModal('usuario')">‚ûï Nuevo Usuario</button>
    <div class="table-container">
        <table>
            <tr>
                <th>ID</th><th>Nombre</th><th>Documento</th><th>Cargo</th><th>Tel√©fono</th><th>Acciones</th>
            </tr>
            <tr th:each="u : ${usuarios}">
                <td th:text="${u.id}"></td>
                <td th:text="${u.nombre}"></td>
                <td th:text="${u.documento}"></td>
                <td th:text="${u.cargo}"></td>
                <td th:text="${u.telefono}"></td>
                <td>
                    <button onclick="editar('usuario', [[${u.id}]])">‚úèÔ∏è</button>
                    <button onclick="eliminar('usuario', [[${u.id}]])">üóëÔ∏è</button>
                </td>
            </tr>
        </table>
    </div>

    <!-- ========== VENTAS ========== -->
    <h2>Ventas</h2>
    <button onclick="abrirModal('venta')">‚ûï Nueva Venta</button>
    <div class="table-container">
        <table>
            <tr>
                <th>ID</th><th>Fecha</th><th>Precio Venta</th><th>Cliente</th><th>Producto</th><th>Acciones</th>
            </tr>
            <tr th:each="v : ${ventas}">
                <td th:text="${v.id}"></td>
                <td th:text="${v.fecha}"></td>
                <td th:text="${v.precioVenta}"></td>
                <td th:text="${v.cliente.nombre}"></td>
                <td th:text="${v.producto.nombre}"></td>
                <td>
                    <button onclick="editar('venta', [[${v.id}]])">‚úèÔ∏è</button>
                    <button onclick="eliminar('venta', [[${v.id}]])">üóëÔ∏è</button>
                </td>
            </tr>
        </table>
    </div>
</div>

<!-- ========= MODAL GEN√âRICO ========= -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title"></h3>
        <form id="modal-form">
            <input type="hidden" id="entidad">
            <input type="hidden" id="id">

            <div id="modal-fields">
                <!-- Cliente -->
                <div id="fields-cliente" style="display:none">
                    <input placeholder="Nombre" id="nombre">
                    <input placeholder="Documento" id="documento">
                    <input placeholder="Email" id="email">
                    <input placeholder="Tel√©fono" id="telefono">
                </div>

                <!-- Producto -->
                <div id="fields-producto" style="display:none">
                    <input placeholder="Nombre" id="nombre">
                    <input placeholder="Precio" id="precio" type="number">
                    <input placeholder="Stock" id="stockMinimo" type="number">
                    <select id="activo">
                        <option value="true">Activo</option>
                        <option value="false">Inactivo</option>
                    </select>
                </div>

                <!-- Proveedor -->
                <div id="fields-proveedor" style="display:none">
                    <input placeholder="Nombre" id="Nombre">
                    <input placeholder="Tel√©fono" id="Telefono">
                    <select id="productoId">
                        <option value="">Seleccione un producto</option>
                        <option th:each="p : ${productos}" th:value="${p.id}" th:text="${p.nombre}"></option>
                    </select>
                </div>

                <!-- Usuario -->
                <div id="fields-usuario" style="display:none">
                    <input placeholder="Nombre" id="nombre">
                    <input placeholder="Documento" id="documento">
                    <input placeholder="Cargo" id="cargo">
                    <input placeholder="Tel√©fono" id="telefono">
                </div>

                <!-- Venta -->
                <div id="fields-venta" style="display:none">
                    <input placeholder="Fecha" id="fecha" type="date">
                    <input placeholder="Precio Venta" id="precioVenta" type="number">
                    <select id="clienteId">
                        <option value="">Seleccione un cliente</option>
                        <option th:each="c : ${clientes}" th:value="${c.id}" th:text="${c.nombre}"></option>
                    </select>
                    <select id="productoId">
                        <option value="">Seleccione un producto</option>
                        <option th:each="p : ${productos}" th:value="${p.id}" th:text="${p.nombre}"></option>
                    </select>
                </div>
            </div>

            <button type="submit">Guardar</button>
            <button type="button" onclick="cerrarModal()">Cancelar</button>
        </form>
    </div>
</div>

<script>
    function abrirModal(entidad) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = "Nuevo " + entidad;
        document.getElementById('entidad').value = entidad;
        document.getElementById('id').value = "";
        generarCampos(entidad);
        limpiarCampos();
    }

    function cerrarModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function limpiarCampos() {
        document.querySelectorAll("#modal-fields input, #modal-fields select").forEach(el => {
            el.value = "";
        });
    }

    function generarCampos(entidad) {
        document.querySelectorAll("#modal-fields > div").forEach(div => div.style.display = "none");
        document.getElementById("fields-" + entidad).style.display = "block";
    }

    document.getElementById('modal-form').onsubmit = async function(e) {
        e.preventDefault();

        const entidad = document.getElementById('entidad').value;
        const id = document.getElementById('id').value;

        // Mapear las entidades a sus endpoints correctos
        const endpoints = {
            'cliente': 'clientes',
            'producto': 'productos',
            'proveedor': 'proveedores',
            'usuario': 'usuarios',
            'venta': 'ventas'
        };

        let url = "/" + endpoints[entidad] + (id ? "/" + id : "");
        let method = id ? "PUT" : "POST";

        let body = {};

        // Recoger todos los campos del formulario
        document.querySelectorAll("#fields-" + entidad + " input, #fields-" + entidad + " select").forEach(el => {
            if(el.value) { // Solo incluir campos con valor
                body[el.id] = el.value;
            }
        });

        // Transformar datos seg√∫n la entidad
        if(entidad === "venta") {
            body = {
                fecha: body.fecha,
                precioVenta: parseInt(body.precioVenta),
                cliente: { id: parseInt(body.clienteId) },
                producto: { id: parseInt(body.productoId) }
            };
            // Eliminar campos que no son parte de la entidad
            delete body.clienteId;
            delete body.productoId;
        } else if(entidad === "proveedor") {
            body = {
                Nombre: body.Nombre,        // May√∫scula para coincidir con la entidad
                Telefono: body.Telefono,    // May√∫scula para coincidir con la entidad
                producto: { id: parseInt(body.productoId) }
            };
            // Eliminar campos que no son parte de la entidad
            delete body.productoId;
        } else if(entidad === "producto") {
            body = {
                nombre: body.nombre,
                precio: parseFloat(body.precio),
                stockMinimo: parseInt(body.stockMinimo),
                activo: body.activo === "true"
            };
        }

        // Si es actualizaci√≥n, incluir el ID
        if(id) {
            body.id = parseInt(id);
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(body)
            });

            if(response.ok) {
                cerrarModal();
                location.reload();
            } else {
                const errorText = await response.text();
                alert("Error al guardar: " + errorText);
            }
        } catch(error) {
            alert("Error de conexi√≥n: " + error.message);
        }
    };

    async function editar(entidad, id) {
        try {
            // Usar el mapeo correcto de endpoints
            const endpoints = {
                'cliente': 'clientes',
                'producto': 'productos',
                'proveedor': 'proveedores',
                'usuario': 'usuarios',
                'venta': 'ventas'
            };

            const resp = await fetch("/" + endpoints[entidad] + "/" + id);
            if(!resp.ok) {
                throw new Error("Error al cargar los datos");
            }

            const data = await resp.json();
            abrirModal(entidad);
            document.getElementById('modal-title').innerText = "Editar " + entidad;
            document.getElementById('id').value = data.id;

            // Llenar campos b√°sicos
            Object.keys(data).forEach(k => {
                const element = document.getElementById(k);
                if(element && typeof data[k] !== 'object') {
                    element.value = data[k];
                }
            });

            // Manejar relaciones y campos especiales
            if(entidad === "venta") {
                if(data.cliente) {
                    document.getElementById('clienteId').value = data.cliente.id;
                }
                if(data.producto) {
                    document.getElementById('productoId').value = data.producto.id;
                }
            } else if(entidad === "proveedor") {
                // Mapear campos con nombres diferentes
                if(data.Nombre) {
                    document.getElementById('Nombre').value = data.Nombre;
                }
                if(data.Telefono) {
                    document.getElementById('Telefono').value = data.Telefono;
                }
                if(data.producto) {
                    document.getElementById('productoId').value = data.producto.id;
                }
            }
        } catch(error) {
            alert("Error al cargar los datos: " + error.message);
        }
    }

    async function eliminar(entidad, id) {
        if(confirm("¬øSeguro que deseas eliminar este " + entidad + "?")) {
            try {
                // Usar el mapeo correcto de endpoints
                const endpoints = {
                    'cliente': 'clientes',
                    'producto': 'productos',
                    'proveedor': 'proveedores',
                    'usuario': 'usuarios',
                    'venta': 'ventas'
                };

                const response = await fetch("/" + endpoints[entidad] + "/" + id, {method: "DELETE"});
                if(response.ok) {
                    location.reload();
                } else {
                    alert("Error al eliminar");
                }
            } catch(error) {
                alert("Error de conexi√≥n: " + error.message);
            }
        }
    }
</script>
</body>
</html>